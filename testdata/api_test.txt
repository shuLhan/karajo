// SPDX-FileCopyrightText: 2023 M. Shulhan <ms@kilabit.info>
// SPDX-License-Identifier: GPL-3.0-or-later

Test HTTP APIs response.

>>> test.conf
[karajo]
name = My karajo
listen_address = 127.0.0.1:32000
http_timeout = 5m0s
secret = s3cret
max_job_running = 1

[job.http "Test success"]
description = HTTP job to for a <i>success</i> call.
secret = s3cret
interval = 1m
http_method = POST
http_url = /karajo/job/test-job-success
http_request_type = json
http_header = X: Y

[job "Test job success"]
path = /test-job-success
secret = s3cret
command = echo "Test job success"
command = echo "Counter is $KARAJO_JOB_COUNTER"
command = x=$(($RANDOM%10)) && echo "sleep in ${x}s" && sleep $x

<<< apiEnvironment.json
{
  "jobs": {
    "Test job success": {
      "path": "/test-job-success",
      "auth_kind": "hmac-sha256",
      "header_sign": "X-Karajo-Sign",
      "commands": [
        "echo Test job success",
        "echo Counter is $KARAJO_JOB_COUNTER",
        "x=$(($RANDOM%10)) \u0026\u0026 echo sleep in ${x}s \u0026\u0026 sleep $x"
      ],
      "last_run": "0001-01-01T00:00:00Z",
      "next_run": "0001-01-01T00:00:00Z",
      "id": "test_job_success",
      "name": "Test job success",
      "log_retention": 5
    }
  },
  "http_jobs": {
    "Test success": {
      "header_sign": "X-Karajo-Sign",
      "http_method": "POST",
      "http_url": "/karajo/job/test-job-success",
      "http_request_type": "json",
      "http_headers": [
        "X: Y"
      ],
      "last_run": "2023-01-09T00:00:00Z",
      "next_run": "2023-01-09T00:01:00Z",
      "id": "test_success",
      "name": "Test success",
      "description": "HTTP job to for a \u003ci\u003esuccess\u003c/i\u003e call.",
      "interval": 60000000000,
      "http_timeout": 300000000000
    }
  },
  "name": "My karajo",
  "listen_address": "127.0.0.1:32000",
  "dir_base": "\u003cREDACTED\u003e",
  "dir_public": "",
  "http_timeout": 300000000000,
  "max_job_running": 1,
  "is_development": false
}

<<< apiJobPause.json
{
  "path": "/test-job-success",
  "auth_kind": "hmac-sha256",
  "header_sign": "X-Karajo-Sign",
  "commands": [
    "echo Test job success",
    "echo Counter is $KARAJO_JOB_COUNTER",
    "x=$(($RANDOM%10)) \u0026\u0026 echo sleep in ${x}s \u0026\u0026 sleep $x"
  ],
  "last_run": "0001-01-01T00:00:00Z",
  "next_run": "0001-01-01T00:00:00Z",
  "id": "test_job_success",
  "name": "Test job success",
  "status": "paused",
  "log_retention": 5
}

<<< apiJobPause_run.json
{
  "code": 412,
  "message": "job is paused",
  "name": "ERR_JOB_PAUSED",
  "data": null
}

<<< apiJobResume.json
{
  "path": "/test-job-success",
  "auth_kind": "hmac-sha256",
  "header_sign": "X-Karajo-Sign",
  "commands": [
    "echo Test job success",
    "echo Counter is $KARAJO_JOB_COUNTER",
    "x=$(($RANDOM%10)) \u0026\u0026 echo sleep in ${x}s \u0026\u0026 sleep $x"
  ],
  "last_run": "0001-01-01T00:00:00Z",
  "next_run": "0001-01-01T00:00:00Z",
  "id": "test_job_success",
  "name": "Test job success",
  "log_retention": 5
}

<<< apiJobRun_success.json
{
  "path": "/test-job-success",
  "auth_kind": "hmac-sha256",
  "header_sign": "X-Karajo-Sign",
  "commands": [
    "echo Test job success",
    "echo Counter is $KARAJO_JOB_COUNTER",
    "x=$(($RANDOM%10)) \u0026\u0026 echo sleep in ${x}s \u0026\u0026 sleep $x"
  ],
  "last_run": "0001-01-01T00:00:00Z",
  "next_run": "0001-01-01T00:00:00Z",
  "id": "test_job_success",
  "name": "Test job success",
  "log_retention": 5
}

<<< apiJobRun_notfound.json
{
  "code": 404,
  "message": "job not found: /test-job-notfound",
  "name": "ERR_JOB_NOT_FOUND"
}

<<< apiJobLog.json
{
  "job_id": "test_job_success",
  "name": "test_job_success.1",
  "status": "started",
  "counter": 1,
  "content": "PFJFREFDVEVEPg=="
}

<<< apiJobHttp_success.json
{
  "header_sign": "X-Karajo-Sign",
  "http_method": "POST",
  "http_url": "/karajo/job/test-job-success",
  "http_request_type": "json",
  "http_headers": [
    "X: Y"
  ],
  "last_run": "2023-01-09T00:00:00Z",
  "next_run": "2023-01-09T00:01:00Z",
  "id": "test_success",
  "name": "Test success",
  "description": "HTTP job to for a \u003ci\u003esuccess\u003c/i\u003e call.",
  "interval": 60000000000,
  "http_timeout": 300000000000
}

<<< apiJobHttp_notfound.json
{
  "code": 400,
  "message": "invalid or empty job id: test_notfound",
  "name": "ERR_INVALID_JOB_ID"
}

<<< apiJobHttpLogs.json
[
  "The first log"
]

<<< apiJobHttpPause.json
{
  "header_sign": "X-Karajo-Sign",
  "http_method": "POST",
  "http_url": "/karajo/job/test-job-success",
  "http_request_type": "json",
  "http_headers": [
    "X: Y"
  ],
  "last_run": "2023-01-09T00:00:00Z",
  "next_run": "2023-01-09T00:01:00Z",
  "id": "test_success",
  "name": "Test success",
  "description": "HTTP job to for a \u003ci\u003esuccess\u003c/i\u003e call.",
  "status": "paused",
  "interval": 60000000000,
  "http_timeout": 300000000000
}

<<< apiJobHttpResume.json
{
  "header_sign": "X-Karajo-Sign",
  "http_method": "POST",
  "http_url": "/karajo/job/test-job-success",
  "http_request_type": "json",
  "http_headers": [
    "X: Y"
  ],
  "last_run": "2023-01-09T00:00:00Z",
  "next_run": "2023-01-09T00:01:00Z",
  "id": "test_success",
  "name": "Test success",
  "description": "HTTP job to for a \u003ci\u003esuccess\u003c/i\u003e call.",
  "status": "started",
  "interval": 60000000000,
  "http_timeout": 300000000000
}
